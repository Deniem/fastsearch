!function(t,s,l){"use strict";function e(s,e){this.$input=t(s),this.options=t.extend(!0,{},t.fastsearch.defaults,e),this.init()}var i=s.app&&s.app.$document||t(l),o=0,n=function(t){return t.keyCode&&13===t.keyCode},u=function(t){return t.keyCode&&27===t.keyCode},h=function(t){return t.keyCode&&40===t.keyCode},r=function(t){return t.keyCode&&38===t.keyCode},a="ontouchstart"in s||"onmsgesturechange"in s,p={init:function(){this.$el=this.$input.closest(this.options.wrapSelector?this.options.wrapSelector:"form"),this.url=this.$el.data("url")||this.options.url||this.$el.attr("action"),this.noResultsText=this.$el.data("no-results-text")||this.options.noResultsText,this.query=null,this.hasResults=!1,this.elIsForm=this.$el.is("form"),this.ens=".fastsearch"+ ++o,this.resultsOpened=!1,this.itemSelector="."+this.options.itemClass.replace(" ","."),this.events()},events:function(){var s=this;this.$input.on("keyup"+this.ens+" focus"+this.ens+" click"+this.ens,function(t){n(t)||s.handleTyping()}).on("keydown"+this.ens,function(t){s.hasResults&&s.resultsOpened&&(h(t)?(t.preventDefault(),s.navigateDown(t)):r(t)?(t.preventDefault(),s.navigateUp(t)):n(t)&&s.onEnter(t))}),this.$el.on("click"+this.ens,this.itemSelector,function(e){e.preventDefault(),s.handleItemSelect(t(this))}),a||this.$el.on("mouseenter"+this.ens,this.itemSelector,function(){s.$input.focus(),s.$resultsCont.find(".focused").removeClass("focused"),t(this).addClass("focused")}).on("mouseleave"+this.ens,this.itemSelector,function(){t(this).removeClass("focused")})},handleTyping:function(){var s=t.trim(this.$input.val()),e=this;return s.length<this.options.minQueryLength?void this.hideResults():s==this.query?void this.showResults():(clearTimeout(this.keyupTimeout),this.$el.addClass(this.options.loadingClass),void(this.keyupTimeout=setTimeout(function(){e.query=s,e.getResults()},this.options.typeTimeout)))},getResults:function(){var s=this,e=this.elIsForm?this.$el.serializeArray():this.$el.find("input, textarea, select").serializeArray();t.get(this.url,e,function(t){s.showResults(s.generateResults(t)),s.hasResults=0!==t.length})},generateResults:function(i){var e,n,s,o;return this.itemModels=[],this.options.template?t(this.options.template(i,this)):(e=t("<div>"),n=this.options.responseFormat,s=this,0===i.length&&(o="function"==typeof this.noResultsText?this.noResultsText.call(this):this.noResultsText,e.html('<p class="'+this.options.noResultsClass+'">'+o+"</p>")),"simpleJSON"===this.options.responseType?t.each(i,function(i,t){e.append(s.generateItem(t))}):"groupedJSON"===this.options.responseType?t.each(i,function(l,i){var o=t('<div class="'+s.options.groupClass+'">').appendTo(e);i[n.groupCaption]&&o.append('<h3 class="'+s.options.groupTitleClass+'">'+i[n.groupCaption]+"</h3>"),t.each(i.items,function(e,t){o.append(s.generateItem(t))}),s.options.onGroupCreate&&s.options.onGroupCreate.call(s,o,i)}):"html"===this.options.responseType&&e.html(i),this.options.onResultsCreate&&this.options.onResultsCreate.call(this,e,i),e.html())},generateItem:function(s){var e=this.options.responseFormat,i=s[e.url],n=t("<"+(i?"a":"span")+">").html(s[e.html]?s[e.html]:s[e.label]).addClass(this.options.itemClass);return this.itemModels.push(s),i&&n.attr("href",i),this.options.onItemCreate&&this.options.onItemCreate.call(this,n,s),n},showResults:function(s){(s||!this.resultsOpened)&&(this.$el.removeClass(this.options.loadingClass).addClass(this.options.resultsOpenedClass),this.$resultsCont=this.$resultsCont||t('<div class="'+this.options.resultsContClass+'">').appendTo(this.$el),s&&(this.$resultsCont.html(s),this.$resultItems=this.$resultsCont.find(this.itemSelector)),this.resultsOpened||(this.documentCancelEvents("on"),this.$input.trigger("openingResults")),this.resultsOpened=!0)},documentCancelEvents:function(e){var s=this;return"off"===e&&this.closeEventsSetuped?(i.off(this.ens),void(this.closeEventsSetuped=!1)):void(this.closeEventsSetuped||(i.on("click"+this.ens+" keyup"+this.ens,function(e){if(u(e))return void s.hideResults();var i=t(e.target);i.parents().is(s.$el)||s.hideResults()}),this.closeEventsSetuped=!0))},navigateDown:function(){var s,t=this.$resultItems.filter(".focused");return 0===t.length?void this.$resultItems.eq(0).addClass("focused"):(s=this.$resultItems.eq(this.$resultItems.index(t)+1),void(s.length?(t.removeClass("focused"),s.addClass("focused")):(t.removeClass("focused"),this.$resultItems.eq(0).addClass("focused"))))},navigateUp:function(){var s,t=this.$resultItems.filter(".focused");return 0===t.length?void this.$resultItems.last().addClass("focused"):(s=this.$resultItems.eq(this.$resultItems.index(t)-1),void(s.length?(t.removeClass("focused"),s.addClass("focused")):(t.removeClass("focused"),this.$resultItems.last().addClass("focused"))))},onEnter:function(s){var t=this.$resultItems.filter(".focused");t.length&&(s.preventDefault(),this.handleItemSelect(t))},handleItemSelect:function(n){var o,e=this.options.onItemSelect,i=this.itemModels.length&&this.itemModels[this.$resultItems.index(n)]||{};this.$input.trigger("itemSelected"),"fillInput"===e?(this.query=i.label,this.$input.val(i.label),o=i.id,o&&(this.$inputId||(this.$inputId=this.$el.find('input[name="'+this.$input.attr("name")+'_id"]'),this.$inputId.length||(this.$inputId=t('<input type="hidden" name="'+this.$input.attr("name")+'_id" />').appendTo(this.$el))),this.$inputId.val(o)),this.hideResults()):"follow"===e?s.location.href=n.attr("href"):"function"==typeof e&&e.call(this,n,i)},hideResults:function(){this.resultsOpened&&(this.$el.removeClass(this.options.resultsOpenedClass),this.resultsOpened=!1,this.$input.trigger("closingResults"),this.documentCancelEvents("off"))},destroy:function(){this.$input.off(this.ens),i.off(this.ens),this.$el.off(this.ens).removeClass(this.options.resultsOpenedClass).removeClass(this.options.loadingClass),this.$resultsCont&&this.$resultsCont.remove(),delete this.$el.data().fastsearch}};t.extend(e.prototype,p),t.fastsearch=e,t.fastsearch.defaults={url:null,wrapSelector:null,responseType:"simpleJSON",resultsContClass:"fs_results",resultsOpenedClass:"fsr_opened",groupClass:"fs_group",itemClass:"fs_result_item",groupTitleClass:"fs_group_title",loadingClass:"loading",noResultsClass:"fs_no_results",typeTimeout:140,minQueryLength:2,template:null,responseFormat:{url:"url",html:"html",label:"label",groupCaption:"caption"},noResultsText:"No results found",onItemSelect:"follow",onResultsCreate:null,onGroupCreate:null,onItemCreate:null},t.fn.fastsearch=function(s){return this.each(function(){t.data(this,"fastsearch")||t.data(this,"fastsearch",new e(this,s))})}}(window.jQuery||window.Zepto,window,document);