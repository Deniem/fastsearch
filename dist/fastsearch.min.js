!function(a,b,c){"use strict";function d(b,c){this.$input=a(b),this.options=a.extend(!0,{},a.fastsearch.defaults,c),this.init()}var e=a(c),f=0,g=function(a){return 13===a.keyCode},h=function(a){return 27===a.keyCode},i=function(a){return 40===a.keyCode},j=function(a){return 38===a.keyCode},k="ontouchstart"in b||"onmsgesturechange"in b;a.extend(d.prototype,{init:function(){this.$el=this.$input.closest(this.options.wrapSelector),this.url=this.$el.data("url")||this.options.url||this.$el.attr("action"),this.noResultsText=this.$el.data("no-results-text")||this.options.noResultsText,this.inputIdName=this.$el.data("input-id-name")||this.options.inputIdName,this.apiInputName=this.$el.data("api-input-name")||this.options.apiInputName,this.query=null,this.hasResults=!1,this.elIsForm=this.$el.is("form"),this.ens=".fastsearch"+ ++f,this.resultsOpened=!1,this.itemSelector="."+this.options.itemClass.replace(/\s/g,"."),this.events()},events:function(){var b=this;this.$input.on("keyup"+this.ens+" focus"+this.ens+" click"+this.ens,function(a){g(a)||b.handleTyping()}).on("keydown"+this.ens,function(a){g(a)&&b.options.preventSubmit&&a.preventDefault(),b.hasResults&&b.resultsOpened&&(i(a)?(a.preventDefault(),b.navigateDown(a)):j(a)?(a.preventDefault(),b.navigateUp(a)):g(a)&&b.onEnter(a))}),this.$el.on("click"+this.ens,this.itemSelector,function(c){c.preventDefault(),b.handleItemSelect(a(this))}),k||(this.$el.on("mouseleave"+this.ens,this.itemSelector,function(){a(this).removeClass("focused")}),this.$el.on("mouseenter"+this.ens,this.itemSelector,function(){b.$resultItems.removeClass("focused"),a(this).addClass("focused")}))},handleTyping:function(){var b=a.trim(this.$input.val()),c=this;return b.length<this.options.minQueryLength?void this.hideResults():b==this.query?void this.showResults():(clearTimeout(this.keyupTimeout),this.$el.addClass(this.options.loadingClass),void(this.keyupTimeout=setTimeout(function(){c.query=b,c.getResults()},this.options.typeTimeout)))},getResults:function(){var b=this,c=this.elIsForm?this.$el.serializeArray():this.$el.find("input, textarea, select").serializeArray();this.apiInputName&&c.push({name:this.apiInputName,value:this.$input.val()}),a.get(this.url,c,function(c){"JSON"===b.options.responseType&&"string"==typeof c&&(c=a.parseJSON(c)),b.showResults(b.generateResults(c)),b.hasResults=0!==c.length})},generateResults:function(b){var c=a("<div>");if(this.itemModels=[],this.options.template)return a(this.options.template(b,this));if(0===b.length){var d="function"==typeof this.noResultsText?this.noResultsText.call(this):this.noResultsText;c.html('<p class="'+this.options.noResultsClass+'">'+d+"</p>")}else"html"===this.options.responseType?c.html(b):b[0][this.options.responseFormat.groupItems]?this.generateGroupedResults(b,c):this.generateSimpleResults(b,c);return this.options.onResultsCreate&&this.options.onResultsCreate.call(this,c,b,this),c.html()},generateSimpleResults:function(b,c){var d=this;a.each(b,function(a,b){c.append(d.generateItem(b))})},generateGroupedResults:function(b,c){var d=this,e=this.options.responseFormat;a.each(b,function(b,f){var g=a('<div class="'+d.options.groupClass+'">').appendTo(c);f[e.groupCaption]&&g.append('<h3 class="'+d.options.groupTitleClass+'">'+f[e.groupCaption]+"</h3>"),a.each(f.items,function(a,b){g.append(d.generateItem(b))}),d.options.onGroupCreate&&d.options.onGroupCreate.call(d,g,f,this)})},generateItem:function(b){var c=this.options.responseFormat,d=b[c.url],e=a("<"+(d?"a":"span")+">").html(b[c.html]?b[c.html]:b[c.label]).addClass(this.options.itemClass);return this.itemModels.push(b),d&&e.attr("href",d),this.options.onItemCreate&&this.options.onItemCreate.call(this,e,b,this),e},showResults:function(b){(b||!this.resultsOpened)&&(this.$el.removeClass(this.options.loadingClass).addClass(this.options.resultsOpenedClass),this.$resultsCont=this.$resultsCont||a('<div class="'+this.options.resultsContClass+'">').appendTo(this.$el),b&&(this.$resultsCont.html(b),this.$resultItems=this.$resultsCont.find(this.itemSelector)),this.resultsOpened||(this.documentCancelEvents("on"),this.$input.trigger("openingResults")),this.resultsOpened=!0)},documentCancelEvents:function(b){var c=this;return"off"===b&&this.closeEventsSetuped?(e.off(this.ens),void(this.closeEventsSetuped=!1)):void(this.closeEventsSetuped||(e.on("click"+this.ens+" keyup"+this.ens,function(b){return h(b)||!a(b.target).is(c.$el)&&!a.contains(c.$el.get(0),b.target)?void c.hideResults():void 0}),this.closeEventsSetuped=!0))},navigateDown:function(){var a=this.$resultItems.filter(".focused");if(0===a.length)return void this.$resultItems.eq(0).addClass("focused");a.removeClass("focused");var b=this.$resultItems.index(a)+1;b<=this.$resultItems.length-1?this.$resultItems.eq(b).addClass("focused"):this.$resultItems.eq(0).addClass("focused")},navigateUp:function(){var a=this.$resultItems.filter(".focused");if(0===a.length)return void this.$resultItems.last().addClass("focused");a.removeClass("focused");var b=this.$resultItems.index(a)-1;b>=0?this.$resultItems.eq(b).addClass("focused"):this.$resultItems.last().addClass("focused")},onEnter:function(a){var b=this.$resultItems.filter(".focused");b.length&&(a.preventDefault(),this.handleItemSelect(b))},handleItemSelect:function(c){var d=this.options.onItemSelect,e=this.itemModels.length&&this.itemModels[this.$resultItems.index(c)]||{},f=this.options.responseFormat;if(this.$input.trigger("itemSelected"),"fillInput"===d){if(this.query=e[f.label],this.$input.val(e[f.label]),e.id){if(!this.$inputId){var g=this.inputIdName||this.$input.attr("name")+"_id";this.$inputId=this.$el.find('input[name="'+g+'"]'),this.$inputId.length||(this.$inputId=a('<input type="hidden" />').attr("name",g).appendTo(this.$el))}this.$inputId.val(e.id)}this.hideResults()}else"follow"===d?b.location.href=c.attr("href"):"function"==typeof d&&d.call(this,c,e,this)},hideResults:function(){return this.resultsOpened?(this.$el.removeClass(this.options.resultsOpenedClass),this.resultsOpened=!1,this.$input.trigger("closingResults"),this.documentCancelEvents("off"),this):void 0},clear:function(){this.hideResults(),this.$input.val("").trigger("change")},destroy:function(){e.off(this.ens),this.$input.off(this.ens),this.$el.off(this.ens).removeClass(this.options.resultsOpenedClass).removeClass(this.options.loadingClass),this.$resultsCont&&this.$resultsCont.remove(),delete this.$el.data().fastsearch}}),a.fastsearch=d,a.fastsearch.defaults={url:null,wrapSelector:"form",responseType:"JSON",preventSubmit:!1,resultsContClass:"fs_results",resultsOpenedClass:"fsr_opened",groupClass:"fs_group",itemClass:"fs_result_item",groupTitleClass:"fs_group_title",loadingClass:"loading",noResultsClass:"fs_no_results",typeTimeout:140,minQueryLength:2,template:null,responseFormat:{url:"url",html:"html",label:"label",groupCaption:"caption",groupItems:"items"},inputIdName:null,apiInputName:null,noResultsText:"No results found",onItemSelect:"follow",onResultsCreate:null,onGroupCreate:null,onItemCreate:null},a.fn.fastsearch=function(b){return this.each(function(){a.data(this,"fastsearch")||a.data(this,"fastsearch",new d(this,b))})}}(window.jQuery||window.Zepto,window,document);