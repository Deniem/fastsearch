!function(a,b,c){function d(b,c){this.$input=a(b),this.options=a.extend(!0,{},d.defaults,c),this.init()}var e=a(c),f=0,g={13:"enter",27:"escape",40:"downArrow",38:"upArrow"};a.extend(d.prototype,{init:function(){this.$el=this.$input.closest(this.options.wrapSelector);var b=this.$el.data(),c=this.options;a.extend(c,{url:b.url||c.url||this.$el.attr("action"),onItemSelect:b.onItemSelect||c.onItemSelect,noResultsText:b.noResultsText||c.noResultsText,inputIdName:b.inputIdName||c.inputIdName,apiInputName:b.apiInputName||c.apiInputName}),this.ens=".fastsearch"+ ++f,this.itemSelector="."+c.itemClass.replace(/\s/g,"."),this.focusedItemSelector="."+c.focusedItemClass.replace(/\s/g,"."),this.events()},events:function(){var b=this,c=this.options;this.$input.on("keyup focus click ".replace(/\s/g,this.ens+" "),function(a){"enter"!==g[a.keyCode]&&b.handleTyping()}).on("keydown"+this.ens,function(a){if("enter"===g[a.keyCode]&&c.preventSubmit&&a.preventDefault(),b.hasResults&&b.resultsOpened)switch(g[a.keyCode]){case"downArrow":a.preventDefault(),b.navigateItem("down");break;case"upArrow":a.preventDefault(),b.navigateItem("up");break;case"enter":b.onEnter(a)}}),this.$el.on("click"+this.ens,this.itemSelector,function(c){c.preventDefault(),b.handleItemSelect(a(this))}),!c.isTouch&&this.$el.on("mouseleave"+this.ens,this.itemSelector,function(b){a(this).removeClass(c.focusedItemClass)}).on("mouseenter"+this.ens,this.itemSelector,function(d){b.$resultItems.removeClass(c.focusedItemClass),a(this).addClass(c.focusedItemClass)})},handleTyping:function(){var b=a.trim(this.$input.val()),c=this;return b.length<this.options.minQueryLength?void this.hideResults():b===this.query?void this.showResults():(this.$el.addClass(this.options.loadingClass),clearTimeout(this.keyupTimeout),void(this.keyupTimeout=setTimeout(function(){c.query=b,c.getResults()},this.options.typeTimeout)))},getResults:function(){var b=this,c=this.$el.find("input, textarea, select").serializeArray();this.options.apiInputName&&c.push({name:this.apiInputName,value:this.$input.val()}),a.get(this.options.url,c,function(a){b.options.parseResponse&&(a=b.options.parseResponse.call(this,a,this)),b.showResults(b.generateResults(a),a),b.hasResults=0!==a.length})},generateResults:function(b){var c=a("<div>"),d=this.options;return this.itemModels=[],d.template?a(d.template(b,this)):(0===b.length?c.html('<p class="'+d.noResultsClass+'">'+("function"==typeof d.noResultsText?d.noResultsText.call(this):d.noResultsText)+"</p>"):"html"===this.options.responseType?c.html(b):this["generate"+(b[0][d.responseFormat.groupItems]?"GroupedResults":"SimpleResults")](b,c),c.html())},generateSimpleResults:function(b,c){var d=this;a.each(b,function(a,b){c.append(d.generateItem(b))})},generateGroupedResults:function(b,c){var d=this,e=this.options,f=e.responseFormat;a.each(b,function(b,g){var h=a('<div class="'+e.groupClass+'">').appendTo(c);g[f.groupCaption]&&h.append('<h3 class="'+e.groupTitleClass+'">'+g[f.groupCaption]+"</h3>"),a.each(g.items,function(a,b){h.append(d.generateItem(b))}),e.onGroupCreate&&e.onGroupCreate.call(d,h,g,this)})},generateItem:function(b){var c=this.options,d=c.responseFormat,e=b[d.url],f=b[d.html]||b[d.label],g=a("<"+(e?"a":"span")+">").html(f).addClass(c.itemClass);return this.itemModels.push(b),e&&g.attr("href",e),c.onItemCreate&&c.onItemCreate.call(this,g,b,this),g},showResults:function(b,c){(b||!this.resultsOpened)&&(this.$el.removeClass(this.options.loadingClass).addClass(this.options.resultsOpenedClass),this.$resultsCont=this.$resultsCont||a("<div>").addClass(this.options.resultsContClass).appendTo(this.$el),b&&(this.$resultsCont.html(b),this.$resultItems=this.$resultsCont.find(this.itemSelector),this.options.onResultsCreate&&this.options.onResultsCreate.call(this,this.$resultsCont,c,this)),this.resultsOpened||(this.documentCancelEvents("on"),this.$input.trigger("openingResults")),this.resultsOpened=!0)},documentCancelEvents:function(b){var c=this;return"off"===b&&this.closeEventsSetuped?(e.off(this.ens),void(this.closeEventsSetuped=!1)):void("on"!==b||this.closeEventsSetuped||(e.on("click"+this.ens+" keyup"+this.ens,function(b){return"escape"===g[b.keyCode]||!a(b.target).is(c.$el)&&!a.contains(c.$el.get(0),b.target)?void c.hideResults():void 0}),this.closeEventsSetuped=!0))},navigateItem:function(a){var b=this.$resultItems.filter(this.focusedItemSelector),c=this.$resultItems.length-1;if(0===b.length)return void this.$resultItems.eq("up"===a?c:0).addClass(this.options.focusedItemClass);var d=this.$resultItems.index(b),e="up"===a?d-1:d+1;e>c&&(e=0),0>e&&(e=c),b.removeClass(this.options.focusedItemClass),this.$resultItems.eq(e).addClass(this.options.focusedItemClass)},navigateDown:function(){this.navigateItem("down")},navigateUp:function(){this.navigateItem("up")},onEnter:function(a){var b=this.$resultItems.filter(this.focusedItemSelector);b.length&&(a.preventDefault(),this.handleItemSelect(b))},handleItemSelect:function(c){var d=this.options.onItemSelect,e=this.itemModels.length?this.itemModels[this.$resultItems.index(c)]:{},f=this.options.responseFormat;if(this.$input.trigger("itemSelected"),"fillInput"===d){if(this.query=e[f.label],this.$input.val(e[f.label]).trigger("change"),this.options.fillInputId&&e.id){if(!this.$inputId){var g=this.options.inputIdName||this.$input.attr("name")+"_id";this.$inputId=this.$el.find('input[name="'+g+'"]'),this.$inputId.length||(this.$inputId=a('<input type="hidden" name="'+g+'" />').appendTo(this.$el))}this.$inputId.val(e.id).trigger("change")}this.hideResults()}else"follow"===d?b.location.href=c.attr("href"):"function"==typeof d&&d.call(this,c,e,this)},hideResults:function(){return this.resultsOpened&&(this.resultsOpened=!1,this.$el.removeClass(this.options.resultsOpenedClass),this.$input.trigger("closingResults"),this.documentCancelEvents("off")),this},clear:function(){return this.hideResults(),this.$input.val("").trigger("change"),this},destroy:function(){e.off(this.ens),this.$input.off(this.ens),this.$el.off(this.ens).removeClass(this.options.resultsOpenedClass).removeClass(this.options.loadingClass),this.$resultsCont&&(this.$resultsCont.remove(),delete this.$resultsCont),delete this.$el.data().fastsearch}}),d.defaults={wrapSelector:"form",url:null,responseType:"JSON",preventSubmit:!1,resultsContClass:"fs_results",resultsOpenedClass:"fsr_opened",groupClass:"fs_group",itemClass:"fs_result_item",groupTitleClass:"fs_group_title",loadingClass:"loading",noResultsClass:"fs_no_results",focusedItemClass:"focused",typeTimeout:140,minQueryLength:2,template:null,isTouch:"ontouchstart"in b||"onmsgesturechange"in b,responseFormat:{url:"url",html:"html",label:"label",groupCaption:"caption",groupItems:"items"},fillInputId:!0,inputIdName:null,apiInputName:null,noResultsText:"No results found",onItemSelect:"follow",parseResponse:null,onResultsCreate:null,onGroupCreate:null,onItemCreate:null},a.fastsearch=d,a.fn.fastsearch=function(b){return this.each(function(){a.data(this,"fastsearch")||a.data(this,"fastsearch",new d(this,b))})}}(window.jQuery||window.Zepto,window,document);