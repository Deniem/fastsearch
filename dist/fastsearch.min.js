!function($,t,n){"use strict";function s(t,s){this.$input=$(t),this.options=$.extend(!0,{},$.fastsearch.defaults,s),this.init()}var e=$(n),o=0,i=function(t){return 13===t.keyCode},l=function(t){return 27===t.keyCode},u=function(t){return 40===t.keyCode},a=function(t){return 38===t.keyCode},h="ontouchstart"in t||"onmsgesturechange"in t;$.extend(s.prototype,{init:function(){this.$el=this.$input.closest(this.options.wrapSelector),this.url=this.$el.data("url")||this.options.url||this.$el.attr("action"),this.noResultsText=this.$el.data("no-results-text")||this.options.noResultsText,this.inputIdName=this.$el.data("input-id-name")||this.options.inputIdName,this.apiInputName=this.$el.data("api-input-name")||this.options.apiInputName,this.query=null,this.hasResults=!1,this.elIsForm=this.$el.is("form"),this.ens=".fastsearch"+ ++o,this.resultsOpened=!1,this.itemSelector="."+this.options.itemClass.replace(" ","."),this.events()},events:function(){var t=this;this.$input.on("keyup"+this.ens+" focus"+this.ens+" click"+this.ens,function(s){i(s)||t.handleTyping()}).on("keydown"+this.ens,function(s){i(s)&&t.options.preventSubmit&&s.preventDefault(),t.hasResults&&t.resultsOpened&&(u(s)?(s.preventDefault(),t.navigateDown(s)):a(s)?(s.preventDefault(),t.navigateUp(s)):i(s)&&t.onEnter(s))}),this.$el.on("click"+this.ens,this.itemSelector,function(s){s.preventDefault(),t.handleItemSelect($(this))}),h||this.$el.on("mouseenter"+this.ens,this.itemSelector,function(){t.$input.focus(),t.$resultsCont.find(".focused").removeClass("focused"),$(this).addClass("focused")}).on("mouseleave"+this.ens,this.itemSelector,function(){$(this).removeClass("focused")})},handleTyping:function(){var t=$.trim(this.$input.val()),s=this;return t.length<this.options.minQueryLength?void this.hideResults():t==this.query?void this.showResults():(clearTimeout(this.keyupTimeout),this.$el.addClass(this.options.loadingClass),void(this.keyupTimeout=setTimeout(function(){s.query=t,s.getResults()},this.options.typeTimeout)))},getResults:function(){var t=this,s=this.elIsForm?this.$el.serializeArray():this.$el.find("input, textarea, select").serializeArray();this.apiInputName&&s.push({name:this.apiInputName,value:this.$input.val()}),$.get(this.url,s,function(s){t.showResults(t.generateResults(s)),t.hasResults=0!==s.length})},generateResults:function(t){var e,s=$("<div>");return this.itemModels=[],this.options.template?$(this.options.template(t,this)):(0===t.length?(e="function"==typeof this.noResultsText?this.noResultsText.call(this):this.noResultsText,s.html('<p class="'+this.options.noResultsClass+'">'+e+"</p>")):"html"===this.options.responseType?s.html(t):t[0][this.options.responseFormat.groupItems]?this.generateGroupedResults(t,s):this.generateSimpleResults(t,s),this.options.onResultsCreate&&this.options.onResultsCreate.call(this,s,t),s.html())},generateSimpleResults:function(t,s){var e=this;$.each(t,function(i,t){s.append(e.generateItem(t))})},generateGroupedResults:function(e,i){var t=this,s=this.options.responseFormat;$.each(e,function(o,e){var n=$('<div class="'+t.options.groupClass+'">').appendTo(i);e[s.groupCaption]&&n.append('<h3 class="'+t.options.groupTitleClass+'">'+e[s.groupCaption]+"</h3>"),$.each(e.items,function(e,s){n.append(t.generateItem(s))}),t.options.onGroupCreate&&t.options.onGroupCreate.call(t,n,e)})},generateItem:function(t){var s=this.options.responseFormat,e=t[s.url],i=$("<"+(e?"a":"span")+">").html(t[s.html]?t[s.html]:t[s.label]).addClass(this.options.itemClass);return this.itemModels.push(t),e&&i.attr("href",e),this.options.onItemCreate&&this.options.onItemCreate.call(this,i,t),i},showResults:function(t){(t||!this.resultsOpened)&&(this.$el.removeClass(this.options.loadingClass).addClass(this.options.resultsOpenedClass),this.$resultsCont=this.$resultsCont||$('<div class="'+this.options.resultsContClass+'">').appendTo(this.$el),t&&(this.$resultsCont.html(t),this.$resultItems=this.$resultsCont.find(this.itemSelector)),this.resultsOpened||(this.documentCancelEvents("on"),this.$input.trigger("openingResults")),this.resultsOpened=!0)},documentCancelEvents:function(s){var t=this;return"off"===s&&this.closeEventsSetuped?(e.off(this.ens),void(this.closeEventsSetuped=!1)):void(this.closeEventsSetuped||(e.on("click"+this.ens+" keyup"+this.ens,function(s){return l(s)?void t.hideResults():void($(s.target).parents().is(t.$el)||t.hideResults())}),this.closeEventsSetuped=!0))},navigateDown:function(){var s,t=this.$resultItems.filter(".focused");return 0===t.length?void this.$resultItems.eq(0).addClass("focused"):(s=this.$resultItems.eq(this.$resultItems.index(t)+1),void(s.length?(t.removeClass("focused"),s.addClass("focused")):(t.removeClass("focused"),this.$resultItems.eq(0).addClass("focused"))))},navigateUp:function(){var s,t=this.$resultItems.filter(".focused");return 0===t.length?void this.$resultItems.last().addClass("focused"):(s=this.$resultItems.eq(this.$resultItems.index(t)-1),void(s.length?(t.removeClass("focused"),s.addClass("focused")):(t.removeClass("focused"),this.$resultItems.last().addClass("focused"))))},onEnter:function(s){var t=this.$resultItems.filter(".focused");t.length&&(s.preventDefault(),this.handleItemSelect(t))},handleItemSelect:function(i){var n,e=this.options.onItemSelect,s=this.itemModels.length&&this.itemModels[this.$resultItems.index(i)]||{},o=this.options.responseFormat;this.$input.trigger("itemSelected"),"fillInput"===e?(this.query=s[o.label],this.$input.val(s[o.label]),s.id&&(this.$inputId||(n=this.inputIdName||this.$input.attr("name")+"_id",this.$inputId=this.$el.find('input[name="'+n+'"]'),this.$inputId.length||(this.$inputId=$('<input type="hidden" />').attr("name",n).appendTo(this.$el))),this.$inputId.val(s.id)),this.hideResults()):"follow"===e?t.location.href=i.attr("href"):"function"==typeof e&&e.call(this,i,s,this)},hideResults:function(){return this.resultsOpened?(this.$el.removeClass(this.options.resultsOpenedClass),this.resultsOpened=!1,this.$input.trigger("closingResults"),this.documentCancelEvents("off"),this):void 0},clear:function(){this.hideResults(),this.$input.val("").trigger("change")},destroy:function(){e.off(this.ens),this.$input.off(this.ens),this.$el.off(this.ens).removeClass(this.options.resultsOpenedClass).removeClass(this.options.loadingClass),this.$resultsCont&&this.$resultsCont.remove(),delete this.$el.data().fastsearch}}),$.fastsearch=s,$.fastsearch.defaults={url:null,wrapSelector:"form",responseType:"JSON",preventSubmit:!1,resultsContClass:"fs_results",resultsOpenedClass:"fsr_opened",groupClass:"fs_group",itemClass:"fs_result_item",groupTitleClass:"fs_group_title",loadingClass:"loading",noResultsClass:"fs_no_results",typeTimeout:140,minQueryLength:2,template:null,responseFormat:{url:"url",html:"html",label:"label",groupCaption:"caption",groupItems:"items"},inputIdName:null,apiInputName:null,noResultsText:"No results found",onItemSelect:"follow",onResultsCreate:null,onGroupCreate:null,onItemCreate:null},$.fn.fastsearch=function(t){return this.each(function(){$.data(this,"fastsearch")||$.data(this,"fastsearch",new s(this,t))})}}(window.jQuery||window.Zepto,window,document);